@model Arasan.Models.IndentSuppMultipleAllocate

@{
    ViewData["Title"] = "Index";
}
 @* <partial name="JqxGridPartial" />*@
@* @Html.Partial("~/Views/JqxGridPartial.cshtml")  *@
     <link href="@Url.Content("~/css/chosen1.css")" rel="stylesheet" />
<div class="row wrapper border-bottom page-heading">
    <div class="col-lg-12">

        <ol class="breadcrumb">
            <li> <a href="#">Home</a> </li>
            <li> <a>Purchase</a> </li>
            <li class="active"> <strong>Purchase Indent Approval</strong> </li>
        </ol>
    </div>
</div>

 <script type="text/javascript">
      $(document).ready(function () {
            var source =
            {
                url: "/PurchaseIndent/ListIndentItemgridSupp",
               datatype: "json",
                updaterow: function (rowid, rowdata) {
                  // synchronize with the server - send update command
              },
                datafields: [
                    { name: 'itemname' },
                    { name: 'itemid' },
                    { name: 'quantity' },
                    { name: 'assign' }
                ],
                id: 'itemid',
            };
              var employeesAdapter = new $.jqx.dataAdapter(source,
                { contentType: 'application/json; charset=utf-8' }, {
                    loadComplete: function () {

                    }
                }
            );
            //alert(JSON.stringify(employeesAdapter));
                         
            var ordersSource =
            {
                 url: "/PurchaseIndent/ListIndentItemgridSuppDetails",
                datafields: [
                     { name: 'piid', type: 'string' },
                    { name: 'itemid', type: 'string' },
                    { name: 'indentno', type: 'string' },
                    { name: 'indentdate', type: 'string' },
                    { name: 'itemname', type: 'string' },
                    { name: 'unit', type: 'string' },
                    { name: 'quantity', type: 'float' },
                    { name: 'location', type: 'string' },
                    { name: 'duedate', type: 'string' }
                ],
               
                datatype: "json",
               
                async: false
            };
              var ordersDataAdapter = new $.jqx.dataAdapter(ordersSource,
                { contentType: 'application/json; charset=utf-8' }, { autoBind: true }
                );
              ordersDataAdapter.dataBind();
            //var ordersDataAdapter2 = new $.jqx.dataAdapter(ordersSource, { autoBind: true });
            var orders = ordersDataAdapter.records;

            console.log(ordersDataAdapter);
            
            var nestedGrids = new Array();
            // create nested grid.
            var initrowdetails = function (index, parentElement, gridElement, record) {
                var id = record.uid.toString();
                var grid = $($(parentElement).children()[0]);
                nestedGrids[index] = grid;
                var filtergroup = new $.jqx.filter();
                var filter_or_operator = 1;
                var filtervalue = id;
                var filtercondition = 'equal';
                var filter = filtergroup.createfilter('stringfilter', filtervalue, filtercondition);
                // fill the orders depending on the id.
                var ordersbyid = [];
                for (var m = 0; m < orders.length; m++) {
                    var result = filter.evaluate(orders[m]["itemid"]);
                    if (result)
                        ordersbyid.push(orders[m]);
                }
                var orderssource = { datafields: [
                    { name: 'piid', type: 'string' },
                    { name: 'itemid', type: 'string' },
                    { name: 'indentno', type: 'string' },
                    { name: 'indentdate', type: 'string' },
                    { name: 'itemname', type: 'string' },
                    { name: 'unit', type: 'string' },
                    { name: 'quantity', type: 'float' },
                    { name: 'location', type: 'string' },
                    { name: 'duedate', type: 'string' }
                ],
                    id: 'piid',
                    localdata: ordersbyid
                }
                var nestedGridAdapter = new $.jqx.dataAdapter(orderssource);
                if (grid != null) {
                    grid.jqxGrid({
                        source: nestedGridAdapter, width: 780, height: 200,
                        columns: [
                          { text: 'Indent No.', aggregates: ["count"], datafield: 'indentno', width: 100 },
                  { text: 'Indent Date', datafield: 'indentdate', width: 100 },
                  { text: 'Item Name', groupable: true, columntype: 'dropdownlist', datafield: 'itemname', width: 200 },
                  { text: 'Due date', datafield: 'duedate', width: 100, cellsalign: 'right' },
                  { text: 'Location', datafield: 'location', width: 200 },
                  { text: 'Quantity', datafield: 'quantity', width: 100 }
                       ]
                    });
                }
            }
             var renderer = function (row, column, value) {
                 
                return '<span style="margin-left: 4px; margin-top: 9px; float: left; ">' + value + '</span>';
            }
             var linkrenderer = function (row, column, value) {
                return '<a href="' + value + '" ><img  src="../Images/D2.png"  style="text-align: center; margin-top: 5px;padding-left:25px;"/></a>';
}
            $("#jqxgrid").jqxGrid(
                {
                    width: getWidth('Grid'),
                    height: 365,
                    source: source,
                    pageable: true,
                    filterable: true,
                    autoheight: true,
                    sortable: true,
                    rowdetails: true,
                    rowsheight: 35,
                    selectionmode: 'checkbox',
                      initrowdetails: initrowdetails,
                    rowdetailstemplate: { rowdetails: "<div id='grid' style='margin: 10px;'></div>", rowdetailsheight: 220, rowdetailshidden: true },
                    ready: function() {
                        $("#jqxgrid").jqxGrid('showrowdetails', 1);
                    },
                    columns: [
                    
                   { text: 'Item Name', datafield: 'itemname', width: 250 },
                    { text: 'Total Quantity', datafield: 'quantity', width: 150 },
                    //{ text: 'Assign Supplier', datafield: 'assign', width: 150 , cellsrenderer: linkrenderer, align: 'center'}
                  ]
            });
        });


      
    </script>
<div class="wrapper-content ">
    <div class="row">
        <div class="col-lg-12">
            <div class="ibox float-e-margins">
                <div class="widgets-container">
                  
                    <form>
                      <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">

                                    <label for="inputName3" class="col-sm-4 control-label">Supplier <label class="mandatory"></label></label>
                                    <div class="col-sm-8">
                                        @Html.DropDownListFor(C => C.PartyName, Model.Partylst, new { @id = "ddlParty", @Class = "form-control chosen-select", @TabIndex = 1 })<br/>
                                    </div>
                                </div>
                            </div>
                            
                        </div>
                        
                            <div style="height:50px;"></div>
                        <div class="row">

                             <div class="col-md-2 "> </div>
                            <div class="col-md-10 "> 
                              <div id="jqxgrid">
    </div>
                            </div>
                           
                        </div>
                        <div style="height:10px;"></div>
                        <div class="row">
                            <div class="col-md-1"></div>
                            <div class="col-md-10">
                                <div style="margin-top: 10px;float:right;">
                                    <input id="button" type="button" value="Generate Enquiry" class="btn btn-success" />
                                </div>
                            </div>
                            <div class="col-md-1"></div>
                            </div>

                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
             //$(".chosen-select").chosen();
            $("#button").click(function () {
                if (confirm('Are you sure want to generate this Enquiry?') == true) {
                    var supid = document.getElementById("ddlParty").value;
                    var rows = $("#jqxgrid").jqxGrid('selectedrowindexes');
                    var selectedRecords = new Array();
                    for (var m = 0; m < rows.length; m++) {
                        var row = $("#jqxgrid").jqxGrid('getrowdata', rows[m]);
                        selectedRecords[selectedRecords.length] = row.itemid;
                        //alert(row.ID);
                    }
                    //window.location.href = "/PurchaseIndent/MultipleSupAllocation?selectedRecord=" + JSON.stringify(selectedRecords)
                    $.ajax({
                        type: "POST",
                        url: "/PurchaseIndent/GridRecordsSave",
                        data: { 'selectedRecord': selectedRecords, 'supid': supid },
                        cache: false,
                        success: function (response) {
                            alert("Approved Successfully..");
                            window.location.reload();
                        },
                        failure: function (response) {
                            alert(response.responseText);
                        },
                        error: function (response) {
                            alert(response.responseText);
                        }
                    });
                }
                else {

                }
            });
           $(".chosen-select").chosen();
        </script>

                            <link rel="stylesheet" href="~/jqwidgets/styles/jqx.base.css" type="text/css" />
<link rel="stylesheet" href="~/jqwidgets/styles/jqx.ui-sunny.css" type="text/css" />

    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1 maximum-scale=1 minimum-scale=1" />
    <script type="text/javascript" src="~/scripts/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="~/jqwidgets/jqxcore.js"></script>
    <script type="text/javascript" src="~/jqwidgets/jqxdata.js"></script> 
    <script type="text/javascript" src="~/jqwidgets/jqxbuttons.js"></script>
    <script type="text/javascript" src="~/jqwidgets/jqxscrollbar.js"></script>
    <script type="text/javascript" src="~/jqwidgets/jqxmenu.js"></script>
    <script type="text/javascript" src="~/jqwidgets/jqxcheckbox.js"></script>
    <script type="text/javascript" src="~/jqwidgets/jqxlistbox.js"></script>
    <script type="text/javascript" src="~/jqwidgets/jqxdropdownlist.js"></script>
    <script type="text/javascript" src="~/jqwidgets/jqxgrid.js"></script>
    <script type="text/javascript" src="~/jqwidgets/jqxgrid.sort.js"></script> 
    <script type="text/javascript" src="~/jqwidgets/jqxgrid.grouping.js"></script>
    <script type="text/javascript" src="~/jqwidgets/jqxgrid.aggregates.js"></script>
    <script type="text/javascript" src="~/jqwidgets/jqxgrid.pager.js"></script> 
    <script type="text/javascript" src="~/jqwidgets/jqxgrid.selection.js"></script> 
    <script type="text/javascript" src="~/jqwidgets/jqxgrid.edit.js"></script> 
    <script type="text/javascript" src="~/jqwidgets/jqxgrid.filter.js"></script> 
    <script type="text/javascript" src="~/scripts/demos.js"></script>